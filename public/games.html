<!DOCTYPE html>
<html>
<head>
    <title>Games</title>
</head>
<body>
    <h2>Available Games</h2>
    <div id="greeting"></div>
    <ul id="gamesList"></ul>
    <button id="logoutButton">Logout</button>

    <script>
        function getCsrfToken() {
            // Function to retrieve CSRF token from cookies
            const csrfToken = document.cookie
                .split('; ')
                .find(row => row.startsWith('XSRF-TOKEN='))
                ?.split('=')[1];
            return decodeURIComponent(csrfToken); // Decode URI component
        }

        function fetchGames() {
            const csrfToken = getCsrfToken(); // Get CSRF token from cookies
            console.log('CSRF Token:', csrfToken);

            fetch('https://decisionserver-51961461dcec.herokuapp.com/api/games', {
                method: 'GET',
                credentials: 'include', // Ensure cookies are included with the request
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken // Add CSRF token to request headers
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const greetingElement = document.getElementById('greeting');
                greetingElement.innerText = `Hi ${data.username}, here are your games:`;

                const gamesList = document.getElementById('gamesList');
                gamesList.innerHTML = ''; // Clear previous entries
                data.games.forEach(game => {
                    let item = document.createElement('li');
                    item.textContent = game.name; // Adjust based on your game data structure
                    gamesList.appendChild(item);
                });
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                // Handle error, potentially redirect to login if unauthorized
            });
        }

        // Call fetchGames function on load
        document.addEventListener('DOMContentLoaded', fetchGames);

        document.getElementById('logoutButton').addEventListener('click', function() {
            fetch('https://decisionauthserver-92e41a504ad4.herokuapp.com/api/auth/logout', {
                method: 'GET',
                credentials: 'include', // Important for including cookies
            })
            .then(response => {
                if (response.ok) {
                    // Redirect to login page or show logged out state
                    window.location.href = '/login.html';
                } else {
                    throw new Error('Logout failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    </script>
</body>
</html>
