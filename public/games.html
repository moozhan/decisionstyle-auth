<!DOCTYPE html>
<html>
<head>
    <title>Games</title>
</head>
<body>
    <h2>Available Games</h2>
    <div id="greeting"></div>
    <ul id="gamesList"></ul>
    <button id="logoutButton">Logout</button>

    <script>
        function getCsrfToken() {
            // Function to retrieve CSRF token from cookies
            const csrfToken = document.cookie
                .split('; ')
                .find(row => row.startsWith('XSRF-TOKEN='))
                ?.split('=')[1];
            return decodeURIComponent(csrfToken); // Decode URI component
        }
        async function fetchGames() {
    const csrfToken = getCsrfToken(); // Get CSRF token from cookies
    console.log(csrfToken)

    try {
        const response = await fetch('http://localhost:3001/api/games', {
            method: 'GET',
            credentials: 'include', // Ensure cookies are included with the request
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': getCsrfToken() // Add CSRF token to request headers
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        const greetingElement = document.getElementById('greeting');
        greetingElement.innerText = `Hi ${data.username}, here are your games:`;

        const gamesList = document.getElementById('gamesList');
        gamesList.innerHTML = '';
        data.games.forEach(game => {
            let item = document.createElement('li');
            item.textContent = game.name;
            gamesList.appendChild(item);
        });
    } catch (error) {
        console.error('Fetch Error:', error);
        alert('Failed to load games. Please check your network connection or log in again.');
    }
}


        // Call fetchGames function on load
        document.addEventListener('DOMContentLoaded', fetchGames);

        document.getElementById('logoutButton').addEventListener('click', function() {
            fetch('http://localhost:3000/api/auth/logout', {
                method: 'GET',
                credentials: 'include', // Important for including cookies
            })
            .then(response => {
                if (response.ok) {
                    // Redirect to login page or show logged out state
                    window.location.href = '/login';
                } else {
                    throw new Error('Logout failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    </script>
</body>
</html>
